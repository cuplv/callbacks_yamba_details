# READABLE MODELS

The file `simplified_model.smv` is a more human readable version of
the SMV model that we usually generate when we verify a trace.

We changed the output of the our tool to produce this more human
readable version. The difference with the previous model format are:
- It separates the different transition systems generated by the
  verifier.
  The verifier does not directly perform the (symbolic) composition of
  the transition systems, which is delegated to nuXmv. 

- It uses human readable names for the variables.

- It adds comments in front of the `MODULE` declarations to map the
  module back to the elements it encodes (e.g. the modules that encode
  a specification have a comment that shows the specification that
  they encode).

The model is still hard to read for the following reasons:
- We encode the messages that label the transitions with a
  a set of Boolean variables.
  For example, to represent a variable that can be assigned to a value
  in the set {1,2,3,4}, we use two Boolean variables b0 and b1, and we
  map an assignment to the Boolean variables to an element of the
  original domain (e.g., the assignment b0 = False, b1 = False is
  mapped to 1...).
  
  Changing the encoding for debug purposes is non-trivial.
  
- The formulas are represented as Directed Acyclic Graphs (DAGs) by
  using SMV `DEFINE` directives.

  The file `simplified_model_no_def.smv` is a version of
  `simplified_model.smv` that prints a tree for the formulas.
  In the "tree" case, the formula printed in SMV is extremely large
  and also not understandable.


Both the SMV models can be verified reusing the same command file `command.cmd`:
```
nuXmv -source command.cmd ./simplified_model.smv
nuXmv -source command.cmd ./simplified_model_no_def.smv
```

# Structure of the SMV model
The model is composed by several modules.

The `main` module declares the message variables used by all the
transition system.

A message is either a callin or a callback invocation, or the callin
or callback returned value, logged from a concrete execution of the
Android App.
A message variable is of Boolean type and when assigned to true
represents that a message is enabled (if it is a callback invocation) or
is allowed (if it is a callin invocation).

The `INIT` and `TRANS` constraints in the `main` module describe a
transition system that, in each step of execution, chooses to execute
the invocation of a callback or a callin. 
The transition system can execute a callback only if it is enabled.
The transition system can choose to execute every callin: if the
callin is not allowed, then the system moves in a sink state.

The `INVARSPEC` specification in the `main` module defines the "safe"
states of the system. The specification holds if the transition system
never executes a callin that is not allowed (and hence, does not reach
the error sink state).

A trace also records the return value of callbacks and callins. Return
values of callbacks and callins are also treated as messages, and are
specular to the invocation of callback and callins: a callin return is
enabled, while a callback return is allowed.
The intuition is that the Android app returns a value from a callback,
while the Android framework returns a value from a callin.


The format of the name used for the message variables is: `enabled_<message>`

`<message>` is the callin or the callback. For example:
```
"enabled_[CB]_[ENTRY]_android.view.View com.marakana.android.yamba.TimelineFragment.onCreateView(android.view.LayoutInflater,android.view.ViewGroup,android.os.Bundle)(212079b,62c574e,NULL,NULL)" : boolean;
```
is the callback
`com.marakana.android.yamba.TimelineFragment.onCreateView` from the
trace that was invoked on the object `212079b` of type
`android.view.View`, with arguments `62c574e`, `NULL`, `NULL`, of types
`android.view.LayoutInflater`,`android.view.ViewGroup`,and `android.os.Bundle`
respectively. The numbers `212079b` and `62c574e` are the addresses of
the objects recorded in the concrete execution.

Each message has an `[ENTRY]` or `[EXIT]`specifier in the name,
to determine if the message refers to the invocation or the return of
a method.


The `main` module declares a set of input variables (`IVAR`declarations)
to encode the
message executed by the system when choosing a transition (the label on the transitions).
The set of the labels is the set of messages seen in the concrete
trace. For example, the message `enabled_[CI]_[ENTRY]_void
android.app.Dialog.dismiss()(cc1bfcc)` is part of the set of labels.

The set of input variables is named `_bit__msg_var__<n>`, where `<n>`
identifies a specific bit in the encoding.
The correspondence between an assignment to the input variables and
the message is kept by the tool, while it is hidden in the SMV model.

The `main` module further defines the constraints on the labels (i.e.
the system can execute a transition labeled with a callback invocation
only if the corresponding message variable is true).

The `main` module further instantiates different submodules, and the
composition of all the constraints in the instantiated modules and in
the `main` module is the transition system that encodes the dynamic
verification problem.


The submodules in the `main` module are:

- The submodule `m1` of type ``mod1` defines all the possible
  reordering of the callbacks seen in the recorded trace.
  
  The possible reordering are then restricted by the constraints
  imposed by Lifestate specifications.
  
- The submodules (named `m2`, ..., `m313` of type `mod2`, ...,
  `mod314`) encode the acceptance of a specification and the effect on
  the system when the regular expression is matched by the current execution.
  
  For example, the module `mod2` encodes the specification:
  ```
  (((TRUE)[*]); [CB] [ENTRY] [b83e03e] void com.marakana.android.yamba.SubActivity.onStop()) |+ [CB] [ENTRY] [b83e03e] void com.marakana.android.yamba.SubActivity.onDestroy()```
 
  The specification tells that, every time the system executes the
  callback `[CB] [ENTRY] [b83e03e] void
  com.marakana.android.yamba.SubActivity.onStop())`, then the callback
  `[CB] [ENTRY] [b83e03e] void
  com.marakana.android.yamba.SubActivity.onDestroy()` must be enabled.
  
  The module encodes in the initial condition `INIT` and in the
  transition relation `TRANS` a deterministic automaton that accepts
  the language of the regular expression and that enables the 
  `[CB] [ENTRY] [b83e03e] void
  com.marakana.android.yamba.SubActivity.onDestroy()` message in the
  case.
  
- The submodule `mod314` encodes the frame condition of the message
  variables.
  Each specification defines when a message should be enabled/disabled
  or allowed/disallowed. If no specifications is matched, the state of
  the message variables must not change in the system.
  This condition must be explicitly described in SMV.

